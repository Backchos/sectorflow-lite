#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
SectorFlow Lite - ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Í∏∞Î∞ò Ï£ºÏãù Î∂ÑÏÑù ÎèÑÍµ¨
"""

import pandas as pd
import numpy as np
import matplotlib
matplotlib.use('Agg')  # GUI ÏóÜÏù¥ Î∞±ÏóîÎìú ÏÇ¨Ïö©
import matplotlib.pyplot as plt
from datetime import datetime, timedelta
import os
import json
import warnings
import yfinance as yf
warnings.filterwarnings('ignore')

# ÌïúÍ∏Ä Ìè∞Ìä∏ ÏÑ§Ï†ï
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

def get_user_input():
    """ÏÇ¨Ïö©ÏûêÎ°úÎ∂ÄÌÑ∞ Î∂ÑÏÑùÌï† Ï¢ÖÎ™© ÏûÖÎ†•Î∞õÍ∏∞"""
    print("=" * 60)
    print("üìà SectorFlow Lite - ÏÇ¨Ïö©Ïûê ÎßûÏ∂§ Ï£ºÏãù Î∂ÑÏÑù")
    print("=" * 60)
    
    print("\nüîç Î∂ÑÏÑùÌï† Ï¢ÖÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:")
    print("1. Ï¢ÖÎ™©ÏΩîÎìú (Ïòà: 005930, 000660)")
    print("2. Ï¢ÖÎ™©Î™Ö (Ïòà: ÏÇºÏÑ±Ï†ÑÏûê, SKÌïòÏù¥ÎãâÏä§)")
    print("3. Ïó¨Îü¨ Ï¢ÖÎ™© (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ: 005930,000660,035720)")
    print("4. KOSPI ÏÉÅÏúÑ 30Í∞ú (Í∏∞Î≥∏Í∞í)")
    
    choice = input("\nÏÑ†ÌÉùÌïòÏÑ∏Ïöî (1-4, Í∏∞Î≥∏Í∞í: 4): ").strip()
    
    if choice == "1":
        symbol = input("Ï¢ÖÎ™©ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: 005930): ").strip()
        return [symbol], f"{symbol} Ï¢ÖÎ™©"
    
    elif choice == "2":
        symbol_name = input("Ï¢ÖÎ™©Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: ÏÇºÏÑ±Ï†ÑÏûê): ").strip()
        # Ï¢ÖÎ™©Î™ÖÏùÑ ÏΩîÎìúÎ°ú Î≥ÄÌôòÌïòÎäî Í∞ÑÎã®Ìïú Îß§Ìïë
        name_to_code = {
            "ÏÇºÏÑ±Ï†ÑÏûê": "005930.KS",
            "SKÌïòÏù¥ÎãâÏä§": "000660.KS", 
            "Ïπ¥Ïπ¥Ïò§": "035720.KS",
            "LGÌôîÌïô": "051910.KS",
            "ÌÅ¨ÎûòÌîÑÌÜ§": "259960.KS",
            "LG": "003550.KS",
            "ÌïúÏßÑÏπº": "180640.KS",
            "SK": "034730.KS",
            "ÏÖÄÌä∏Î¶¨Ïò®": "068270.KS",
            "ÏÇºÏÑ±Î∞îÏù¥Ïò§Î°úÏßÅÏä§": "207940.KS"
        }
        
        if symbol_name in name_to_code:
            return [name_to_code[symbol_name]], f"{symbol_name} Ï¢ÖÎ™©"
        else:
            print(f"‚ö†Ô∏è '{symbol_name}' Ï¢ÖÎ™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.")
            print("ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï¢ÖÎ™©:", list(name_to_code.keys()))
            return get_user_input()
    
    elif choice == "3":
        symbols_input = input("Ï¢ÖÎ™©ÏΩîÎìúÎì§ÏùÑ ÏâºÌëúÎ°ú Íµ¨Î∂ÑÌïòÏó¨ ÏûÖÎ†•ÌïòÏÑ∏Ïöî: ").strip()
        symbols = [s.strip() + ".KS" for s in symbols_input.split(",")]
        return symbols, f"{len(symbols)}Í∞ú Ï¢ÖÎ™©"
    
    else:  # Í∏∞Î≥∏Í∞í: KOSPI ÏÉÅÏúÑ 30Í∞ú
        kospi_symbols = [
            "005930.KS", "000660.KS", "035720.KS", "051910.KS", "259960.KS",
            "003550.KS", "180640.KS", "034730.KS", "068270.KS", "207940.KS",
            "066570.KS", "323410.KS", "000270.KS", "161890.KS", "032830.KS",
            "000810.KS", "017670.KS", "006400.KS", "000720.KS", "105560.KS",
            "012330.KS", "003670.KS", "015760.KS", "018260.KS", "086280.KS",
            "003490.KS", "024110.KS", "000990.KS", "011200.KS", "128940.KS"
        ]
        return kospi_symbols, "KOSPI ÏÉÅÏúÑ 30Í∞ú Ï¢ÖÎ™©"

def get_date_range():
    """Î∂ÑÏÑù Í∏∞Í∞Ñ ÏÑ§Ï†ï"""
    print("\nüìÖ Î∂ÑÏÑù Í∏∞Í∞ÑÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî:")
    print("1. ÏµúÍ∑º 1Í∞úÏõî")
    print("2. ÏµúÍ∑º 3Í∞úÏõî (Í∏∞Î≥∏Í∞í)")
    print("3. ÏµúÍ∑º 6Í∞úÏõî")
    print("4. ÏµúÍ∑º 1ÎÖÑ")
    print("5. ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï")
    
    choice = input("ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (1-5, Í∏∞Î≥∏Í∞í: 2): ").strip()
    
    end_date = datetime.now()
    
    if choice == "1":
        start_date = end_date - timedelta(days=30)
    elif choice == "3":
        start_date = end_date - timedelta(days=180)
    elif choice == "4":
        start_date = end_date - timedelta(days=365)
    elif choice == "5":
        try:
            start_str = input("ÏãúÏûëÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (YYYY-MM-DD): ").strip()
            end_str = input("Ï¢ÖÎ£åÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (YYYY-MM-DD, Í∏∞Î≥∏Í∞í: Ïò§Îäò): ").strip()
            start_date = datetime.strptime(start_str, "%Y-%m-%d")
            if end_str:
                end_date = datetime.strptime(end_str, "%Y-%m-%d")
        except ValueError:
            print("‚ö†Ô∏è ÎÇ†Ïßú ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. Í∏∞Î≥∏Í∞í(3Í∞úÏõî)ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.")
            start_date = end_date - timedelta(days=90)
    else:  # Í∏∞Î≥∏Í∞í: 3Í∞úÏõî
        start_date = end_date - timedelta(days=90)
    
    return start_date, end_date

def fetch_stock_data(symbols, start_date, end_date):
    """Ï£ºÏãù Îç∞Ïù¥ÌÑ∞ ÏàòÏßë"""
    print(f"\nüìä {len(symbols)}Í∞ú Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë...")
    print(f"üìÖ Í∏∞Í∞Ñ: {start_date.strftime('%Y-%m-%d')} ~ {end_date.strftime('%Y-%m-%d')}")
    
    all_data = {}
    failed_symbols = []
    
    for i, symbol in enumerate(symbols, 1):
        try:
            print(f"  [{i}/{len(symbols)}] {symbol} ÏàòÏßë Ï§ë...", end=" ")
            
            # yfinanceÎ°ú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            ticker = yf.Ticker(symbol)
            df = ticker.history(start=start_date, end=end_date)
            
            if df.empty:
                print("‚ùå Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå")
                failed_symbols.append(symbol)
                continue
            
            # Ïª¨ÎüºÎ™Ö Ï†ïÎ¶¨
            df.reset_index(inplace=True)
            df.columns = ['date', 'open', 'high', 'low', 'close', 'volume', 'dividends', 'stock_splits']
            df = df[['date', 'open', 'high', 'low', 'close', 'volume']]
            
            all_data[symbol] = df
            print("‚úÖ")
            
        except Exception as e:
            print(f"‚ùå Ïò§Î•ò: {str(e)[:50]}")
            failed_symbols.append(symbol)
    
    if failed_symbols:
        print(f"\n‚ö†Ô∏è {len(failed_symbols)}Í∞ú Ï¢ÖÎ™© ÏàòÏßë Ïã§Ìå®: {failed_symbols}")
    
    print(f"‚úÖ {len(all_data)}Í∞ú Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏôÑÎ£å")
    return all_data

def calculate_analysis_metrics(all_data):
    """Î∂ÑÏÑù ÏßÄÌëú Í≥ÑÏÇ∞"""
    print("\nüîß Î∂ÑÏÑù ÏßÄÌëú Í≥ÑÏÇ∞ Ï§ë...")
    
    results = {}
    
    for symbol, df in all_data.items():
        if df.empty:
            continue
            
        # Í∏∞Î≥∏ ÏàòÏùµÎ•† Í≥ÑÏÇ∞
        df['returns'] = df['close'].pct_change()
        df['log_returns'] = np.log(df['close'] / df['close'].shift(1))
        
        # ÎàÑÏ†Å ÏàòÏùµÎ•†
        df['cumulative_returns'] = (1 + df['returns']).cumprod() - 1
        
        # Î≥ÄÎèôÏÑ± (20Ïùº Î°§ÎßÅ)
        df['volatility'] = df['returns'].rolling(window=20).std() * np.sqrt(252)
        
        # ÏÉ§ÌîÑ ÎπÑÏú® (Ïó∞Í∞ÑÌôî)
        if df['returns'].std() > 0:
            sharpe_ratio = (df['returns'].mean() * 252) / (df['returns'].std() * np.sqrt(252))
        else:
            sharpe_ratio = 0
        
        # ÏµúÎåÄ ÎÇôÌè≠ (Max Drawdown)
        rolling_max = df['cumulative_returns'].expanding().max()
        drawdown = df['cumulative_returns'] - rolling_max
        max_drawdown = drawdown.min()
        
        # Í±∞ÎûòÎüâ Î∂ÑÏÑù
        avg_volume = df['volume'].mean()
        volume_volatility = df['volume'].std() / avg_volume if avg_volume > 0 else 0
        
        results[symbol] = {
            'total_return': df['cumulative_returns'].iloc[-1] if not df.empty else 0,
            'volatility': df['volatility'].iloc[-1] if not df.empty else 0,
            'sharpe_ratio': sharpe_ratio,
            'max_drawdown': max_drawdown,
            'avg_volume': avg_volume,
            'volume_volatility': volume_volatility,
            'data': df
        }
    
    return results

def generate_analysis_report(results, analysis_title, start_date, end_date):
    """Î∂ÑÏÑù Î≥¥Í≥†ÏÑú ÏÉùÏÑ±"""
    print(f"\nüìù {analysis_title} Î∂ÑÏÑù Î≥¥Í≥†ÏÑú ÏÉùÏÑ± Ï§ë...")
    
    # Í≤∞Í≥º Ï†ïÎ†¨
    sorted_results = sorted(results.items(), key=lambda x: x[1]['total_return'], reverse=True)
    
    # HTML Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
    html_content = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{analysis_title} - SectorFlow Lite Î∂ÑÏÑù</title>
    <style>
        body {{
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }}
        .header {{
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }}
        .content {{
            padding: 30px;
        }}
        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }}
        .stat-card {{
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 5px solid #3498db;
        }}
        .stat-number {{
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }}
        .stat-label {{
            color: #7f8c8d;
            margin-top: 5px;
        }}
        .table {{
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }}
        .table th, .table td {{
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }}
        .table th {{
            background-color: #f8f9fa;
            font-weight: bold;
        }}
        .positive {{
            color: #27ae60;
            font-weight: bold;
        }}
        .negative {{
            color: #e74c3c;
            font-weight: bold;
        }}
        .summary {{
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà {analysis_title}</h1>
            <p>SectorFlow Lite - AI Í∏∞Î∞ò Ï£ºÏãù Î∂ÑÏÑù ÏãúÏä§ÌÖú</p>
            <p>Î∂ÑÏÑù Í∏∞Í∞Ñ: {start_date.strftime('%Y-%m-%d')} ~ {end_date.strftime('%Y-%m-%d')}</p>
        </div>
        
        <div class="content">
"""
    
    # ÌÜµÍ≥Ñ ÏöîÏïΩ
    total_return = np.mean([r['total_return'] for r in results.values()])
    positive_count = sum(1 for r in results.values() if r['total_return'] > 0)
    avg_volatility = np.mean([r['volatility'] for r in results.values()])
    avg_sharpe = np.mean([r['sharpe_ratio'] for r in results.values()])
    
    html_content += f"""
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{len(results)}</div>
                    <div class="stat-label">Î∂ÑÏÑù Ï¢ÖÎ™©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{total_return:.2%}</div>
                    <div class="stat-label">ÌèâÍ∑† ÏàòÏùµÎ•†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{positive_count}</div>
                    <div class="stat-label">ÏÉÅÏäπ Ï¢ÖÎ™©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{avg_volatility:.2%}</div>
                    <div class="stat-label">ÌèâÍ∑† Î≥ÄÎèôÏÑ±</div>
                </div>
            </div>
            
            <h2>üìä Ï¢ÖÎ™©Î≥Ñ Î∂ÑÏÑù Í≤∞Í≥º</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>ÏàúÏúÑ</th>
                        <th>Ï¢ÖÎ™©ÏΩîÎìú</th>
                        <th>ÏàòÏùµÎ•†</th>
                        <th>Î≥ÄÎèôÏÑ±</th>
                        <th>ÏÉ§ÌîÑÎπÑÏú®</th>
                        <th>ÏµúÎåÄÎÇôÌè≠</th>
                    </tr>
                </thead>
                <tbody>
"""
    
    # Ï¢ÖÎ™©Î≥Ñ Í≤∞Í≥º ÌÖåÏù¥Î∏î
    for i, (symbol, metrics) in enumerate(sorted_results, 1):
        return_class = "positive" if metrics['total_return'] > 0 else "negative"
        html_content += f"""
                    <tr>
                        <td>{i}</td>
                        <td>{symbol}</td>
                        <td class="{return_class}">{metrics['total_return']:.2%}</td>
                        <td>{metrics['volatility']:.2%}</td>
                        <td>{metrics['sharpe_ratio']:.2f}</td>
                        <td>{metrics['max_drawdown']:.2%}</td>
                    </tr>
"""
    
    html_content += """
                </tbody>
            </table>
            
            <div class="summary">
                <h3>üìà Î∂ÑÏÑù ÏöîÏïΩ</h3>
                <ul>
                    <li><strong>Î∂ÑÏÑù ÏãúÏ†ê:</strong> """ + datetime.now().strftime('%Y-%m-%d %H:%M:%S') + """</li>
                    <li><strong>Î∂ÑÏÑù ÎèÑÍµ¨:</strong> SectorFlow Lite v1.0</li>
                    <li><strong>Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:</strong> Yahoo Finance (yfinance)</li>
                    <li><strong>Î∂ÑÏÑù Î∞©Î≤ï:</strong> Í∏∞Ïà†Ï†Å Î∂ÑÏÑù + Î¶¨Ïä§ÌÅ¨ ÏßÄÌëú</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
"""
    
    # HTML ÌååÏùº Ï†ÄÏû•
    filename = f"analysis_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"‚úÖ Î∂ÑÏÑù Î≥¥Í≥†ÏÑú ÏÉùÏÑ± ÏôÑÎ£å: {filename}")
    return filename

def main():
    """Î©îÏù∏ Ïã§Ìñâ Ìï®Ïàò"""
    try:
        # ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Î∞õÍ∏∞
        symbols, analysis_title = get_user_input()
        start_date, end_date = get_date_range()
        
        # Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
        all_data = fetch_stock_data(symbols, start_date, end_date)
        
        if not all_data:
            print("‚ùå ÏàòÏßëÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÌîÑÎ°úÍ∑∏Îû®ÏùÑ Ï¢ÖÎ£åÌï©ÎãàÎã§.")
            return
        
        # Î∂ÑÏÑù ÏßÄÌëú Í≥ÑÏÇ∞
        results = calculate_analysis_metrics(all_data)
        
        # Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
        report_file = generate_analysis_report(results, analysis_title, start_date, end_date)
        
        print(f"\nüéâ Î∂ÑÏÑù ÏôÑÎ£å!")
        print(f"üìä Î∂ÑÏÑù ÎåÄÏÉÅ: {analysis_title}")
        print(f"üìÖ Î∂ÑÏÑù Í∏∞Í∞Ñ: {start_date.strftime('%Y-%m-%d')} ~ {end_date.strftime('%Y-%m-%d')}")
        print(f"üìù Î≥¥Í≥†ÏÑú ÌååÏùº: {report_file}")
        print(f"\nüí° Î≥¥Í≥†ÏÑúÎ•º Ïó¥Î†§Î©¥ ÌååÏùºÏùÑ ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!")
        
    except KeyboardInterrupt:
        print("\n\nüëã ÏÇ¨Ïö©ÏûêÏóê ÏùòÌï¥ Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.")
    except Exception as e:
        print(f"\n‚ùå Ïò§Î•ò Î∞úÏÉù: {str(e)}")

if __name__ == "__main__":
    main()

